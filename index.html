<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="robots" content="noindex, nofollow, noarchive">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>My Warfarin</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d0e66">
    
    <link rel="icon" href="Warfarin.png">
    <link rel="apple-touch-icon" href="Warfarin.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            --primary: #0d0e66;
            --bg: #f4f6f9;
            --surface: #ffffff;
            --text: #333333;
            --text-muted: #666666;
            --border: #e0e0e0;
            --success: #28a745;
            --danger: #dc3545;
            --font-size: 16px;
        }
        [data-theme="dark"] {
            --bg: #121212; --surface: #1e1e1e; --text: #e0e0e0;
            --text-muted: #a0a0a0; --border: #333333;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-size: var(--font-size); transition: background 0.3s, color 0.3s; }
        
        nav { 
            background: var(--primary); color: white; padding: 10px 20px; 
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;
            position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        .nav-brand { font-weight: bold; display: flex; align-items: center; gap: 10px; flex-shrink: 0; font-size: 1.1em; width: 220px; }
        .nav-links { display: flex; gap: 5px; flex-wrap: wrap; flex-grow: 1; justify-content: center; padding: 0 10px; }
        .nav-links a { color: white; text-decoration: none; cursor: pointer; padding: 8px 12px; border-radius: 6px; white-space: nowrap; transition: background 0.2s; }
        .nav-links a:hover, .nav-links a.active { background: rgba(255,255,255,0.2); font-weight: bold; }
        .controls { display: flex; align-items: center; justify-content: flex-end; gap: 15px; flex-shrink: 0; width: 220px; }
        .controls span { cursor: pointer; }
        .logout-btn { color: #ff6b6b; font-weight: bold; cursor: pointer; text-decoration: none; margin-left: 5px; padding: 8px 0; }
        
        .container { max-width: 900px; margin: 20px auto; padding: 0 15px; }
        .card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        
        input[type="text"], input[type="password"], input[type="number"], input[type="date"], input[type="time"], select, button { width: 100%; padding: 14px; margin: 8px 0; border: 1px solid var(--border); border-radius: 8px; background: var(--surface); color: var(--text); font-size: 1rem; appearance: none; }
        .input-group { display: flex; align-items: center; margin: 8px 0; }
        .input-group input { margin: 0; border-radius: 8px 0 0 8px; border-right: none; }
        .input-group span { background: var(--border); padding: 14px; border-radius: 0 8px 8px 0; border: 1px solid var(--border); font-weight: bold; color: var(--text-muted); }
        
        button.primary { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; transition: opacity 0.2s; }
        button.primary:hover { opacity: 0.9; }
        button.danger { background: var(--danger); color: white; border: none; font-weight: bold; cursor: pointer; transition: opacity 0.2s; }
        button.danger:hover { opacity: 0.9; }
        
        .table-responsive { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; margin-top: 10px; border-radius: 8px; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; text-align: left; min-width: 400px; }
        th { background: rgba(13, 14, 102, 0.05); }
        th, td { padding: 12px 15px; border-bottom: 1px solid var(--border); }

        #toast { visibility: hidden; min-width: 250px; background-color: var(--primary); color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 2000; left: 50%; transform: translateX(-50%); bottom: 30px; box-shadow: 0px 4px 10px rgba(0,0,0,0.2); }
        #toast.show { visibility: visible; animation: fadein 0.3s, fadeout 0.3s 2.7s; }
        @keyframes fadein { from { bottom: 0; opacity: 0; } to { bottom: 30px; opacity: 1; } }
        @keyframes fadeout { from { bottom: 30px; opacity: 1; } to { bottom: 0; opacity: 0; } }

        .view { display: none; }
        .view.active { display: block; animation: fadeInView 0.3s ease-in-out; }

        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 5px; }
        .cal-day-header { text-align: center; font-weight: bold; padding: 8px 0; background: var(--border); border-radius: 6px; font-size: 0.9em; }
        .cal-cell { border: 1px solid var(--border); border-radius: 6px; min-height: 85px; padding: 5px; cursor: pointer; display: flex; flex-direction: column; }
        .cal-dose { background: var(--primary); color: white; border-radius: 4px; padding: 4px 2px; font-size: 0.85em; text-align: center; margin-top: auto; font-weight: bold; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 3000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal.active { display: flex; }
        .modal-content { background: var(--surface); padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; }

        .chart-wrapper { position: relative; height: 250px; width: 100%; }

        @media (max-width: 850px) {
            nav { padding: 15px; gap: 12px; }
            .nav-brand { width: auto; }
            .controls { width: auto; flex-grow: 1; gap: 12px; }
            .nav-links { width: 100%; justify-content: flex-start; overflow-x: auto; flex-wrap: nowrap; order: 3; }
        }
    </style>
</head>
<body>

<nav id="top-nav" style="display: none;">
    <div class="nav-brand">
        <img src="Warfarin.png" alt="My Warfarin Logo" style="width: 28px; height: 28px; border-radius: 4px;"> 
        <span class="brand-text">My Warfarin</span>
    </div>
    <div class="nav-links">
        <a onclick="showView('dashboard')" data-target="dashboard">Dashboard</a>
        <a onclick="showView('calendar')" data-target="calendar">Calendar</a>
        <a onclick="showView('history')" data-target="history">INR History</a>
        <a onclick="showView('reports')" data-target="reports">Reports</a>
        <a onclick="showView('settings')" data-target="settings">Settings</a>
    </div>
    <div class="controls">
        <span onclick="adjustText(-1)">A-</span>
        <span onclick="adjustText(1)">A+</span>
        <span onclick="toggleTheme()" id="theme-icon">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
        </span>
        <a onclick="logout()" class="logout-btn">Logout</a>
    </div>
</nav>

<div class="container">
    <div id="login-view" class="view active card" style="max-width: 400px; margin: 10vh auto; text-align: center;">
        <img src="Warfarin.png" alt="My Warfarin Logo" style="width: 72px; height: 72px; margin-bottom: 10px;">
        <h2 style="color: var(--primary); margin-top: 0; margin-bottom: 25px;">My Warfarin</h2>
        
        <input type="text" id="username" placeholder="Username">
        <div class="input-group">
            <input type="password" id="password" placeholder="Password">
            <span id="toggle-pwd-icon" onclick="togglePassword()" style="background: var(--surface); cursor: pointer; display: flex; align-items: center; border-left:none;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
            </span>
        </div>
        
        <div style="text-align: left; margin: 15px 0 5px 5px;">
            <label style="cursor: pointer; display: inline-flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="remember-me" checked style="width: auto; margin: 0; transform: scale(1.2);"> 
                <span style="font-size: 0.95rem; color: var(--text-muted);">Stay signed in</span>
            </label>
        </div>

        <button class="primary" onclick="login()" style="margin-top: 15px;">Login</button>
    </div>

    <div id="dashboard-view" class="view">
        <h2>Dashboard <span id="view-mode-badge" style="color:var(--danger); font-size:14px; margin-left: 10px;"></span></h2>
        
        <div class="card" style="background: var(--primary); color: white; text-align: center; padding: 25px 20px;">
            <h3 style="margin-top:0; color: white; letter-spacing: 1px;">TODAY'S DOSE</h3>
            <p id="dashboard-today-date" style="margin: 5px 0 15px 0; opacity: 0.85; font-size: 1.1em;"></p>
            <div id="dashboard-today-dose" style="font-size: 2.5em; font-weight: bold;">-</div>
        </div>

        <div class="card"><div class="chart-wrapper"><canvas id="dashboardChart"></canvas></div></div>
        <div class="card">
            <h3>Last 12 Results</h3>
            <div class="table-responsive"><table><thead><tr><th>Date</th><th>Result</th><th>Status</th></tr></thead><tbody id="dashboard-list"></tbody></table></div>
        </div>
    </div>

    <div id="calendar-view" class="view">
        <h2>Dosage Calendar</h2>
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <button class="primary" style="width:auto;" onclick="changeMonth(-1)">&laquo; Prev</button>
                <h3 id="cal-month-year" style="margin:0;">Month Year</h3>
                <button class="primary" style="width:auto;" onclick="changeMonth(1)">Next &raquo;</button>
            </div>
            <div class="cal-grid" id="cal-grid-headers">
                <div class="cal-day-header">Sun</div><div class="cal-day-header">Mon</div><div class="cal-day-header">Tue</div><div class="cal-day-header">Wed</div><div class="cal-day-header">Thu</div><div class="cal-day-header">Fri</div><div class="cal-day-header">Sat</div>
            </div>
            <div class="cal-grid" id="cal-grid-days"></div>
        </div>
    </div>

    <div id="history-view" class="view">
        <h2>INR History</h2>
        <div class="card" id="inr-input-area">
            <h3>Add / Edit Result</h3>
            <label>Date</label><input type="date" id="inr-date">
            <label>INR Result</label><input type="number" id="inr-result" step="0.1" onkeypress="if(event.key === 'Enter') saveINR()">
            <button class="primary" onclick="saveINR()">Save Result</button>
        </div>
        <div class="card">
            <div class="chart-wrapper"><canvas id="historyChart"></canvas></div>
            <div class="table-responsive" style="margin-top:20px;">
                <table>
                    <thead><tr><th>Date</th><th>Result</th><th>Status</th><th style="text-align:right;">Actions</th></tr></thead>
                    <tbody id="history-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="reports-view" class="view">
        <h2>Export Reports</h2>
        <div class="card">
            <label>Start Date</label><input type="date" id="rep-start">
            <label>End Date</label><input type="date" id="rep-end">
            <button class="primary" onclick="generateReport('inr', 'pdf')">INR PDF Report</button>
            <button class="primary" onclick="generateReport('calendar', 'pdf')">Calendar PDF Report</button>
        </div>
    </div>

    <div id="settings-view" class="view">
        <h2>Settings</h2>
        <div class="card" id="admin-panel" style="display:none; border-left: 5px solid var(--danger);">
            <h3>Admin Panel</h3>
            <input type="text" id="adm-user" placeholder="Username">
            <input type="password" id="adm-pass" placeholder="Password">
            <select id="adm-role"><option value="user">User</option><option value="viewer">Viewer</option><option value="admin">Admin</option></select>
            <button class="primary" onclick="saveAdminUser()">Add/Update User</button>
            <div class="table-responsive"><table><thead><tr><th>User</th><th>Role</th><th>Action</th></tr></thead><tbody id="admin-user-list"></tbody></table></div>
        </div>
        
        <div class="card">
            <h3>Profile & Target Range</h3>
            <label>Patient Full Name</label>
            <input type="text" id="prof-name" placeholder="Full Name">
            <label>Date of Birth</label>
            <input type="date" id="prof-dob">
            
            <h3 style="margin-top: 25px;">Target INR Range</h3>
            <div style="display:flex; gap: 10px;">
                <div style="flex:1;"><label>Min</label><input type="number" id="target-min" placeholder="2.5" step="0.1"></div>
                <div style="flex:1;"><label>Max</label><input type="number" id="target-max" placeholder="3.5" step="0.1"></div>
            </div>

            <h3 style="margin-top: 25px;">Daily Reminder</h3>
            
            <div style="margin-bottom: 15px;">
                <label style="cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-weight: bold; color: var(--text);">
                    <input type="checkbox" id="reminder-enabled" style="width: auto; margin: 0; transform: scale(1.3);"> 
                    Enable Daily Reminder
                </label>
            </div>

            <div style="display: flex; gap: 10px; align-items: stretch; flex-wrap: wrap;">
                <input type="time" id="reminder-time" style="flex: 1; min-width: 120px; margin: 0;">
                <button class="primary" style="flex: 1; min-width: 150px; margin: 0; background: #17a2b8;" onclick="enableNotifications()">Grant Browser Permission</button>
            </div>
            
            <p style="font-size: 0.85em; color: var(--text-muted); line-height: 1.5; margin-top: 15px; background: rgba(220, 53, 69, 0.05); padding: 15px; border-radius: 8px; border-left: 4px solid var(--danger);">
                <strong style="color: var(--danger);">IMPORTANT SAFETY WARNING:</strong> This reminder feature is provided as a secondary convenience only and <strong>must NOT be relied upon as your primary method</strong> for remembering medication. Technical factors and background power-saving settings on all devices (including Android, iOS, and Desktops) can cause notifications to be delayed, silenced, or fail to trigger entirely. Because missing a dose of Warfarin carries significant medical risks, you must use a dedicated, fail-safe alarm or physical pill-organizer as your primary reminder system. By enabling this feature, you acknowledge that you remain solely responsible for your medication schedule and that this app is not a substitute for professional medical management.
            </p>
            
            <button class="primary" onclick="saveSettings()" style="margin-top: 15px;">Save Changes</button>
        </div>

        <div class="card">
            <h3>Data Backup & Restore</h3>
            <p style="font-size: 0.9em; color: var(--text-muted);">Download a backup of your INR results and dosages, or restore from a previous backup file.</p>
            <div style="display:flex; gap:10px; flex-wrap: wrap; margin-top: 10px;">
                <button class="primary" style="flex: 1; min-width: 150px; background: #28a745; margin: 0;" onclick="downloadBackup()">Download Backup</button>
                <div style="flex: 1; min-width: 150px; display: flex;">
                    <input type="file" id="restore-file" style="display:none;" accept=".json" onchange="restoreBackup(event)">
                    <button class="primary" style="width: 100%; margin: 0; background: #ffc107; color: #333;" onclick="document.getElementById('restore-file').click()">Restore Backup</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>Share Medical Data</h3>
            <p>Your Code: <strong id="my-share-code">-</strong> <button class="primary" style="width:auto; padding:5px 10px;" onclick="copyShareCode()">Copy</button></p>
            <label>View Shared Data</label>
            <div style="display:flex; gap:10px; align-items: stretch; flex-wrap: wrap;">
                <input type="text" id="saved-share-code" placeholder="Enter Family Code" style="flex:1; margin:0; min-width:150px;" onkeypress="if(event.key === 'Enter') applyShareCode()">
                <button class="primary" style="width:auto; margin:0;" onclick="applyShareCode()">View</button>
                <button class="danger" style="width:auto; margin:0;" onclick="clearShareCode()">Stop Viewing</button>
            </div>
        </div>
    </div>
</div>

<div id="dose-modal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top: 0; color: var(--primary);">Log Dosage</h3>
        <input type="date" id="modal-dose-date" readonly>
        <input type="number" id="modal-dose-amount" placeholder="Dose (mg)" step="0.5" onkeypress="if(event.key === 'Enter') saveModalDose()">
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="primary" onclick="saveModalDose()">Save</button>
            <button class="danger" onclick="deleteModalDose()">Delete</button>
            <button style="background: var(--border); color: var(--text);" onclick="closeDoseModal()">Cancel</button>
        </div>
    </div>
</div>

<div id="delete-modal" class="modal">
    <div class="modal-content" style="text-align: center;">
        <h3 style="margin-top: 0; color: var(--danger);">Confirm Deletion</h3>
        <p id="delete-confirm-text" style="margin-bottom: 25px; color: var(--text);">Are you sure you want to delete this result?</p>
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button class="danger" onclick="confirmDeleteINR()" style="flex: 1;">Delete</button>
            <button style="background: var(--border); color: var(--text); flex: 1;" onclick="closeDeleteModal()">Cancel</button>
        </div>
    </div>
</div>

<div id="toast">Message</div>

<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js')
            .then(reg => console.log('PWA Service Worker Registered!'))
            .catch(err => console.error('PWA Registration Failed!', err));
        });
    }

    let appData = { settings: { target_min: 2.5, target_max: 3.5, reminder_time: '09:00', reminder_enabled: 0 }, inr: [], dosages: [], view_only: false };
    let charts = {};
    let currentCalDate = new Date();
    let pendingDeleteDate = null;

    window.addEventListener('DOMContentLoaded', async () => {
        document.getElementById('inr-date').valueAsDate = new Date(); 
        
        const token = localStorage.getItem('warfarin_remember_token');
        if (token) {
            const res = await apiCall('auto_login', {token: token});
            if (res.success) {
                processSuccessfulLogin(res.role);
            } else {
                localStorage.removeItem('warfarin_remember_token');
            }
        }
    });

    setInterval(() => {
        if (appData && appData.settings && appData.settings.reminder_enabled == 1 && appData.settings.reminder_time && ("Notification" in window) && Notification.permission === "granted") {
            const now = new Date();
            const currentHHMM = String(now.getHours()).padStart(2, '0') + ":" + String(now.getMinutes()).padStart(2, '0');
            
            if (currentHHMM === appData.settings.reminder_time) {
                const todayStr = now.toLocaleDateString();
                const lastNotified = localStorage.getItem('warfarin_last_notified');
                
                if (lastNotified !== todayStr) {
                    new Notification("My Warfarin Reminder", {
                        body: "It is time to check today's Warfarin dose!",
                        icon: "Warfarin.png"
                    });
                    localStorage.setItem('warfarin_last_notified', todayStr);
                }
            }
        }
    }, 60000); 

    function enableNotifications() {
        if (!("Notification" in window)) {
            showToast("Your browser does not support notifications.");
        } else if (Notification.permission === "granted") {
            showToast("Permission already granted! Check the box to enable.");
        } else if (Notification.permission !== "denied") {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    showToast("Browser Permission Granted!");
                } else {
                    showToast("Permission denied by browser.");
                }
            });
        }
    }

    function showToast(msg) {
        const t = document.getElementById("toast"); t.innerText = msg; t.className = "show";
        setTimeout(() => t.className = "", 3000);
    }

    async function apiCall(action, payload = null) {
        const opts = { method: payload ? 'POST' : 'GET' };
        if(payload) { opts.headers = {'Content-Type': 'application/json'}; opts.body = JSON.stringify(payload); }
        const res = await fetch(`api.php?action=${action}`, opts);
        return res.json();
    }

    document.getElementById('password').addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            login();
        }
    });

    async function login() {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        const r = document.getElementById('remember-me').checked; 
        
        const res = await apiCall('login', {username: u, password: p, remember: r});
        if (res.success) {
            if (res.token) {
                localStorage.setItem('warfarin_remember_token', res.token);
            } else {
                localStorage.removeItem('warfarin_remember_token');
            }
            processSuccessfulLogin(res.role);
        } else { showToast(res.error); }
    }

    async function processSuccessfulLogin(role) {
        document.getElementById('top-nav').style.display = 'flex';
        document.getElementById('login-view').classList.remove('active');
        if(role === 'admin') { document.getElementById('admin-panel').style.display = 'block'; loadAdminUsers(); }
        await loadData();
        showView('dashboard');
    }

    async function logout() { 
        localStorage.removeItem('warfarin_remember_token');
        await apiCall('logout'); 
        location.reload(); 
    }

    function togglePassword() {
        const p = document.getElementById('password');
        const iconSpan = document.getElementById('toggle-pwd-icon');
        if (p.type === 'password') {
            p.type = 'text';
            iconSpan.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>`;
        } else {
            p.type = 'password';
            iconSpan.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>`;
        }
    }

    function showView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(viewId + '-view').classList.add('active');
        
        document.querySelectorAll('.nav-links a').forEach(a => a.classList.remove('active'));
        const activeLink = document.querySelector(`.nav-links a[data-target="${viewId}"]`);
        if(activeLink) activeLink.classList.add('active');

        if(viewId === 'dashboard') renderDashboard();
        if(viewId === 'history') renderHistory();
        if(viewId === 'calendar') renderCalendar();
    }

    async function loadData() {
        const res = await apiCall('get_data');
        if(!res.success) return;
        appData = res;
        
        document.getElementById('prof-name').value = appData.settings.name || '';
        // UPDATED: Now loads and displays the saved Date of Birth correctly
        document.getElementById('prof-dob').value = appData.settings.dob || '';
        document.getElementById('target-min').value = appData.settings.target_min;
        document.getElementById('target-max').value = appData.settings.target_max;
        document.getElementById('reminder-time').value = appData.settings.reminder_time || '09:00'; 
        document.getElementById('reminder-enabled').checked = (appData.settings.reminder_enabled == 1);
        document.getElementById('my-share-code').innerText = appData.settings.share_code;
        document.getElementById('saved-share-code').value = appData.settings.saved_share_code || '';
        
        document.getElementById('view-mode-badge').innerText = appData.view_only ? "(Viewing Shared Profile)" : "";
        
        renderDashboard();
        renderCalendar();
        renderHistory();
    }

    async function saveSettings() {
        const payload = {
            name: document.getElementById('prof-name').value, 
            dob: document.getElementById('prof-dob').value,
            target_min: document.getElementById('target-min').value, 
            target_max: document.getElementById('target-max').value,
            reminder_time: document.getElementById('reminder-time').value,
            reminder_enabled: document.getElementById('reminder-enabled').checked ? 1 : 0
        };
        if((await apiCall('save_settings', payload)).success) { 
            showToast("Saved!"); 
            loadData(); 
        }
    }

    async function downloadBackup() {
        const res = await apiCall('backup');
        if (res.success) {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(res.backup));
            const dlAnchorElem = document.createElement('a');
            dlAnchorElem.setAttribute("href", dataStr);
            dlAnchorElem.setAttribute("download", "mywarfarin_backup_" + new Date().toISOString().slice(0,10) + ".json");
            document.body.appendChild(dlAnchorElem);
            dlAnchorElem.click();
            dlAnchorElem.remove();
        } else {
            showToast("Backup failed.");
        }
    }

    function restoreBackup(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if (data.inr && data.dosages) {
                    const res = await apiCall('restore', data);
                    if (res.success) {
                        showToast("Data Restored!");
                        loadData();
                        document.getElementById('restore-file').value = ''; 
                    } else {
                        showToast("Restore failed.");
                    }
                } else {
                    showToast("Invalid backup file.");
                }
            } catch (err) {
                showToast("Error reading file.");
            }
        };
        reader.readAsText(file);
    }

    function drawChart(canvasId, labels, data) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        if(charts[canvasId]) charts[canvasId].destroy();
        
        let pointColors = data.map(val => (val < appData.settings.target_min || val > appData.settings.target_max) ? '#dc3545' : '#0d0e66');

        charts[canvasId] = new Chart(ctx, {
            type: 'line',
            data: { 
                labels: labels, 
                datasets: [{ label: 'INR', data: data, borderColor: '#0d0e66', fill: true, tension: 0.1, pointBackgroundColor: pointColors }] 
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { 
                    annotation: { 
                        annotations: { 
                            target: { type: 'box', yMin: appData.settings.target_min, yMax: appData.settings.target_max, backgroundColor: 'rgba(40,167,69,0.1)', drawTime: 'beforeDatasetsDraw' } 
                        } 
                    } 
                }
            }
        });
    }

    function renderDashboard() {
        const today = new Date();
        const displayDate = today.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const lookupDate = `${year}-${month}-${day}`;
        
        document.getElementById('dashboard-today-date').innerText = displayDate;
        
        const doseEntry = appData.dosages.find(r => r.date === lookupDate);
        const doseElem = document.getElementById('dashboard-today-dose');
        
        if (doseEntry && doseEntry.dose) {
            doseElem.innerText = doseEntry.dose + " mg";
            doseElem.style.fontSize = "2.5em";
        } else {
            doseElem.innerText = "No dose entered";
            doseElem.style.fontSize = "1.5em";
        }

        const list = document.getElementById('dashboard-list'); list.innerHTML = '';
        let top12 = appData.inr.slice(0, 12).reverse();
        let labels = top12.map(r => r.date), values = top12.map(r => r.result);
        top12.reverse().forEach(r => {
            list.innerHTML += `<tr><td>${r.date}</td><td>${r.result}</td><td>${getStatusHTML(r.result)}</td></tr>`;
        });
        drawChart('dashboardChart', labels, values);
    }

    function changeMonth(dir) {
        currentCalDate.setMonth(currentCalDate.getMonth() + dir);
        renderCalendar();
    }

    function renderCalendar() {
        const year = currentCalDate.getFullYear(), month = currentCalDate.getMonth();
        document.getElementById('cal-month-year').innerText = currentCalDate.toLocaleString('default', {month:'long', year:'numeric'});
        const first = new Date(year, month, 1).getDay(), days = new Date(year, month + 1, 0).getDate();
        const grid = document.getElementById('cal-grid-days'); grid.innerHTML = '';
        
        const today = new Date();
        const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

        for(let i=0; i<first; i++) grid.innerHTML += '<div></div>';
        for(let i=1; i<=days; i++) {
            const dStr = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            const dose = appData.dosages.find(d => d.date === dStr);
            
            const extraStyle = (dStr === todayStr) ? 'border: 2px solid var(--primary); background: rgba(13, 14, 102, 0.05);' : '';
            
            grid.innerHTML += `<div class="cal-cell" style="${extraStyle}" onclick="openDoseModal('${dStr}')"><b style="${dStr === todayStr ? 'color: var(--primary); font-size: 1.1em;' : ''}">${i}</b>${dose ? `<div class="cal-dose">${dose.dose}mg</div>`:''}</div>`;
        }
    }

    function openDoseModal(date) {
        if(appData.view_only) return;
        document.getElementById('modal-dose-date').value = date;
        const dose = appData.dosages.find(d => d.date === date);
        document.getElementById('modal-dose-amount').value = dose ? dose.dose : '';
        document.getElementById('dose-modal').classList.add('active');
        setTimeout(() => document.getElementById('modal-dose-amount').focus(), 100);
    }
    
    function closeDoseModal() { document.getElementById('dose-modal').classList.remove('active'); }
    
    async function saveModalDose() {
        const d = document.getElementById('modal-dose-date').value;
        const a = document.getElementById('modal-dose-amount').value;
        if(!a) return;
        await apiCall('save_dose', {date: d, dose: a});
        closeDoseModal();
        showToast("Dose Saved!");
        loadData();
    }
    
    async function deleteModalDose() {
        const d = document.getElementById('modal-dose-date').value;
        await apiCall('delete_dose', {date: d});
        closeDoseModal();
        showToast("Dose Deleted!");
        loadData(); 
    }

    function renderHistory() {
        const list = document.getElementById('history-list'); list.innerHTML = '';
        let labels = [], values = [];
        let sorted = [...appData.inr].sort((a,b) => new Date(a.date) - new Date(b.date));
        sorted.forEach(r => { labels.push(r.date); values.push(r.result); });
        
        [...sorted].reverse().forEach(r => {
            list.innerHTML += `<tr>
                <td>${r.date}</td>
                <td>${r.result}</td>
                <td>${getStatusHTML(r.result)}</td>
                ${appData.view_only ? '' : `<td style="text-align:right;">
                    <button style="padding:4px 8px; width:auto; margin:0;" onclick="editINR('${r.date}', ${r.result})">Edit</button>
                    <button class="danger" style="padding:4px 8px; width:auto; margin:0; margin-left:5px;" onclick="promptDeleteINR('${r.date}')">Del</button>
                </td>`}
            </tr>`;
        });
        drawChart('historyChart', labels, values);
    }
    
    async function saveINR() {
        const d = document.getElementById('inr-date').value;
        const r = document.getElementById('inr-result').value;
        if(!d || !r) return;
        await apiCall('save_inr', {date: d, result: r});
        document.getElementById('inr-result').value = '';
        showToast("Saved!");
        loadData();
    }

    function editINR(date, result) {
        document.getElementById('inr-date').value = date;
        document.getElementById('inr-result').value = result;
        window.scrollTo({ top: 0, behavior: 'smooth' });
        setTimeout(() => document.getElementById('inr-result').focus(), 100);
    }

    function promptDeleteINR(date) {
        if(appData.view_only) return;
        pendingDeleteDate = date;
        document.getElementById('delete-confirm-text').innerText = "Are you sure you want to delete the result for " + date + "?";
        document.getElementById('delete-modal').classList.add('active');
    }

    function closeDeleteModal() {
        pendingDeleteDate = null;
        document.getElementById('delete-modal').classList.remove('active');
    }

    async function confirmDeleteINR() {
        if(pendingDeleteDate) {
            await apiCall('delete_inr', {date: pendingDeleteDate});
            showToast("Result Deleted!");
            closeDeleteModal();
            loadData();
        }
    }

    function generateReport(type, format) {
        if(!window.jspdf) { showToast("PDF Library loading, please wait..."); return; }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const start = document.getElementById('rep-start').value;
        const end = document.getElementById('rep-end').value;
        
        if (type === 'inr') {
            doc.setFontSize(18);
            doc.text("INR History Report", 14, 20);
            doc.setFontSize(11);
            doc.text(`Patient Name: ${appData.settings.name || 'N/A'}`, 14, 30);
            doc.text(`DOB: ${appData.settings.dob || 'N/A'}`, 14, 36);
            doc.text(`Target Range: ${appData.settings.target_min} - ${appData.settings.target_max}`, 14, 42);
            doc.text(`Date Range: ${start || 'All'} to ${end || 'All'}`, 14, 48);

            let data = [...appData.inr];
            if (start) data = data.filter(d => d.date >= start);
            if (end) data = data.filter(d => d.date <= end);
            data.sort((a,b) => new Date(b.date) - new Date(a.date));

            let body = data.map(d => [d.date, d.result, (d.result < appData.settings.target_min ? 'Low' : (d.result > appData.settings.target_max ? 'High' : 'Within Range'))]);
            doc.autoTable({ startY: 55, head: [['Date', 'INR Result', 'Status']], body: body });
            doc.save(`MyWarfarin_INR_Report.pdf`);
            showToast("Report Generated!");
        } 
        else if (type === 'calendar') {
            let data = [...appData.dosages];
            if (start) data = data.filter(d => d.date >= start);
            if (end) data = data.filter(d => d.date <= end);
            
            if (data.length === 0) { showToast("No dose data found for this range."); return; }

            let minDateStr = start || data.reduce((min, p) => p.date < min ? p.date : min, data[0].date);
            let maxDateStr = end || data.reduce((max, p) => p.date > max ? p.date : max, data[0].date);

            let [sY, sM] = minDateStr.split('-');
            let [eY, eM] = maxDateStr.split('-');

            let currentMonth = new Date(sY, sM - 1, 1);
            let endMonth = new Date(eY, eM - 1, 1);
            let firstPage = true;

            while (currentMonth <= endMonth) {
                if (!firstPage) doc.addPage();
                
                let mYear = currentMonth.getFullYear();
                let mMonth = currentMonth.getMonth();
                let monthName = currentMonth.toLocaleString('default', { month: 'long', year: 'numeric' });

                if (firstPage) {
                    doc.setFontSize(18); doc.text("Dosage Calendar Report", 14, 20);
                    doc.setFontSize(11);
                    doc.text(`Patient: ${appData.settings.name || 'N/A'}  |  DOB: ${appData.settings.dob || 'N/A'}`, 14, 28);
                }
                
                doc.setFontSize(16);
                doc.text(`${monthName}`, 14, firstPage ? 40 : 20);

                let daysInMonth = new Date(mYear, mMonth + 1, 0).getDate();
                let firstDayOfWeek = new Date(mYear, mMonth, 1).getDay();
                let body = [], week = new Array(7).fill(""), currentDay = 1;

                for (let i = firstDayOfWeek; i < 7; i++) {
                    let dStr = `${mYear}-${String(mMonth+1).padStart(2,'0')}-${String(currentDay).padStart(2,'0')}`;
                    let dose = appData.dosages.find(d => d.date === dStr);
                    week[i] = `${currentDay}\n${dose ? dose.dose + ' mg' : ''}`;
                    currentDay++;
                }
                body.push(week);

                while (currentDay <= daysInMonth) {
                    week = new Array(7).fill("");
                    for (let i = 0; i < 7 && currentDay <= daysInMonth; i++) {
                        let dStr = `${mYear}-${String(mMonth+1).padStart(2,'0')}-${String(currentDay).padStart(2,'0')}`;
                        let dose = appData.dosages.find(d => d.date === dStr);
                        week[i] = `${currentDay}\n${dose ? dose.dose + ' mg' : ''}`;
                        currentDay++;
                    }
                    body.push(week);
                }

                doc.autoTable({
                    startY: firstPage ? 45 : 25,
                    head: [['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']],
                    body: body,
                    theme: 'grid',
                    styles: { minCellHeight: 25, valign: 'top', halign: 'left', cellPadding: 2 },
                    headStyles: { fillColor: [13, 14, 102], textColor: 255, halign: 'center' }
                });

                firstPage = false;
                currentMonth.setMonth(currentMonth.getMonth() + 1);
            }
            doc.save(`MyWarfarin_Calendar_Report.pdf`);
            showToast("Report Generated!");
        }
    }

    function getStatusHTML(v) {
        if(v < appData.settings.target_min) return '<span style="color: var(--danger); font-weight: bold;">Low</span>';
        if(v > appData.settings.target_max) return '<span style="color: var(--danger); font-weight: bold;">High</span>';
        return '<span style="color: var(--success); font-weight: bold;">Within Range</span>';
    }

    function copyShareCode() {
        navigator.clipboard.writeText(appData.settings.share_code).then(() => {
            showToast("Code copied to clipboard!");
        });
    }

    async function applyShareCode() {
        const c = document.getElementById('saved-share-code').value;
        if(!c) { showToast("Please enter a code"); return; }
        await apiCall('update_share_code', {code: c});
        await loadData();
        showView('dashboard');
        showToast("Viewing Family Member!");
    }

    async function clearShareCode() {
        await apiCall('update_share_code', {code: null});
        document.getElementById('saved-share-code').value = '';
        showToast("Returned to your profile.");
        await loadData();
        showView('dashboard');
    }

    function adjustText(n) {
        let s = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--font-size'));
        document.documentElement.style.setProperty('--font-size', (s + n) + 'px');
    }

    const sunIcon = `<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`;
    const moonIcon = `<svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M9.528 1.718a.75.75 0 01.162.819A8.97 8.97 0 009 6a9 9 0 009 9 8.97 8.97 0 003.463-.69.75.75 0 01.981.98 10.503 10.503 0 01-9.694 6.46c-5.799 0-10.5-4.701-10.5-10.5 0-4.368 2.667-8.112 6.46-9.694a.75.75 0 01.818.162z"></path></svg>`;

    function toggleTheme() {
        const d = document.documentElement;
        const iconSpan = document.getElementById('theme-icon');
        if (d.getAttribute('data-theme') === 'dark') {
            d.removeAttribute('data-theme');
            iconSpan.innerHTML = sunIcon;
        } else {
            d.setAttribute('data-theme', 'dark');
            iconSpan.innerHTML = moonIcon;
        }
    }
</script>
</body>
</html>
